# Comparing `tmp/intelliw-2.1.0-py3-none-any.whl.zip` & `tmp/intelliw-2.1.1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,37 +1,37 @@
-Zip file size: 210491 bytes, number of entries: 120
+Zip file size: 224536 bytes, number of entries: 121
 -rw-r--r--  2.0 unx    10244 b- defN 24-Jan-17 02:33 intelliw/.DS_Store
--rw-r--r--  2.0 unx      730 b- defN 24-Apr-30 03:38 intelliw/__init__.py
+-rw-r--r--  2.0 unx      730 b- defN 24-May-21 03:00 intelliw/__init__.py
 -rw-r--r--  2.0 unx      887 b- defN 24-Apr-11 09:04 intelliw/feature.py
 -rwxr-xr-x  2.0 unx    10062 b- defN 24-Apr-30 01:35 intelliw/prepare_env.sh
 -rw-r--r--  2.0 unx        0 b- defN 22-Sep-19 01:43 intelliw/algorithms_demo/README.md
 -rw-r--r--  2.0 unx     5519 b- defN 24-Jan-17 03:33 intelliw/algorithms_demo/algorithm.py
 -rw-r--r--  2.0 unx      270 b- defN 23-Nov-17 06:25 intelliw/algorithms_demo/algorithm.yaml
 -rw-r--r--  2.0 unx        0 b- defN 22-Sep-19 01:43 intelliw/algorithms_demo/requirements.txt
 -rw-r--r--  2.0 unx        0 b- defN 22-Sep-19 01:43 intelliw/config/__init__.py
 -rw-r--r--  2.0 unx     4446 b- defN 24-Apr-30 01:35 intelliw/config/cfg_parser.py
--rw-r--r--  2.0 unx     5506 b- defN 24-Apr-30 03:33 intelliw/config/config.py
+-rw-r--r--  2.0 unx     5506 b- defN 24-May-20 09:11 intelliw/config/config.py
 -rw-r--r--  2.0 unx     5460 b- defN 24-Mar-19 03:30 intelliw/config/dataset_config.py
 -rw-r--r--  2.0 unx        0 b- defN 22-Sep-19 01:43 intelliw/core/__init__.py
 -rw-r--r--  2.0 unx     9507 b- defN 24-Apr-09 09:22 intelliw/core/al_decorator.py
 -rw-r--r--  2.0 unx     5891 b- defN 23-Nov-17 06:25 intelliw/core/custom.py
 -rw-r--r--  2.0 unx      744 b- defN 24-Apr-11 09:04 intelliw/core/infer.py
 -rw-r--r--  2.0 unx     9617 b- defN 24-Feb-22 12:15 intelliw/core/linkserver.py
--rw-r--r--  2.0 unx    29548 b- defN 24-Apr-30 03:35 intelliw/core/pipeline.py
+-rw-r--r--  2.0 unx    30801 b- defN 24-May-11 02:59 intelliw/core/pipeline.py
 -rw-r--r--  2.0 unx     2357 b- defN 24-Apr-09 09:22 intelliw/core/recorder.py
 -rw-r--r--  2.0 unx      903 b- defN 24-Jan-17 03:33 intelliw/core/trainer.py
 -rw-r--r--  2.0 unx      675 b- defN 24-Mar-19 03:30 intelliw/datasets/__init__.py
 -rw-r--r--  2.0 unx     9230 b- defN 24-Apr-30 01:33 intelliw/datasets/dataset_writer.py
 -rw-r--r--  2.0 unx     8669 b- defN 24-Mar-19 03:30 intelliw/datasets/datasets.py
 -rw-r--r--  2.0 unx     3691 b- defN 24-Mar-19 03:30 intelliw/datasets/datasource_base.py
 -rw-r--r--  2.0 unx     1006 b- defN 24-Feb-04 03:07 intelliw/datasets/datasource_empty.py
 -rw-r--r--  2.0 unx     6847 b- defN 24-Feb-04 03:07 intelliw/datasets/datasource_intelliv.py
 -rw-r--r--  2.0 unx     8850 b- defN 24-Feb-04 03:07 intelliw/datasets/datasource_iwfactorydata.py
 -rw-r--r--  2.0 unx    15959 b- defN 24-Feb-04 03:07 intelliw/datasets/datasource_iwimgdata.py
--rw-r--r--  2.0 unx     9096 b- defN 24-Apr-16 08:38 intelliw/datasets/datasource_large_model.py
+-rw-r--r--  2.0 unx     9441 b- defN 24-May-20 09:11 intelliw/datasets/datasource_large_model.py
 -rw-r--r--  2.0 unx     5248 b- defN 24-Feb-04 03:07 intelliw/datasets/datasource_local_csv.py
 -rw-r--r--  2.0 unx    14853 b- defN 24-Apr-09 09:22 intelliw/datasets/datasource_nlp_corpora.py
 -rw-r--r--  2.0 unx     2102 b- defN 24-Feb-04 03:07 intelliw/datasets/datasource_remote_csv.py
 -rw-r--r--  2.0 unx     7424 b- defN 24-Feb-04 03:07 intelliw/datasets/datasource_semantic.py
 -rw-r--r--  2.0 unx    13871 b- defN 24-Apr-11 11:57 intelliw/datasets/spliter.py
 -rw-r--r--  2.0 unx    12226 b- defN 23-Nov-17 06:25 intelliw/docs/Q&A.md
 -rw-r--r--  2.0 unx     3144 b- defN 23-Nov-17 06:25 intelliw/docs/README.md
@@ -41,17 +41,17 @@
 -rw-r--r--  2.0 unx    37584 b- defN 24-Apr-09 09:22 intelliw/functions/feature_process.py
 -rw-r--r--  2.0 unx      619 b- defN 22-Sep-19 01:43 intelliw/functions/general.py
 -rw-r--r--  2.0 unx     1486 b- defN 22-Nov-11 07:28 intelliw/functions/matrix.py
 -rw-r--r--  2.0 unx     1711 b- defN 22-Nov-11 07:28 intelliw/functions/opencv.py
 -rw-r--r--  2.0 unx      650 b- defN 23-Feb-03 02:24 intelliw/functions/post.py
 -rw-r--r--  2.0 unx      779 b- defN 22-Sep-19 09:35 intelliw/functions/select_columns.py
 -rw-r--r--  2.0 unx      171 b- defN 22-Sep-19 01:43 intelliw/interface/__init__.py
--rw-r--r--  2.0 unx    12892 b- defN 24-Apr-30 03:33 intelliw/interface/apihandler.py
+-rw-r--r--  2.0 unx    13133 b- defN 24-May-16 09:09 intelliw/interface/apihandler.py
 -rw-r--r--  2.0 unx      533 b- defN 24-Mar-21 09:26 intelliw/interface/apijob.py
--rw-r--r--  2.0 unx     8014 b- defN 24-Apr-09 09:22 intelliw/interface/batchjob.py
+-rw-r--r--  2.0 unx     7938 b- defN 24-May-11 02:59 intelliw/interface/batchjob.py
 -rw-r--r--  2.0 unx     4240 b- defN 24-Jan-18 07:18 intelliw/interface/controller.py
 -rw-r--r--  2.0 unx     1255 b- defN 23-Dec-25 06:03 intelliw/interface/customjob.py
 -rw-r--r--  2.0 unx     8504 b- defN 23-Nov-17 06:25 intelliw/interface/entrypoint.py
 -rw-r--r--  2.0 unx     1300 b- defN 24-Mar-13 09:21 intelliw/interface/trainjob.py
 -rw-r--r--  2.0 unx     6148 b- defN 24-Feb-27 09:36 intelliw/utils/.DS_Store
 -rw-r--r--  2.0 unx      201 b- defN 24-Apr-09 09:22 intelliw/utils/__init__.py
 -rw-r--r--  2.0 unx     4824 b- defN 24-Apr-09 07:47 intelliw/utils/cGroup.py
@@ -59,22 +59,23 @@
 -rw-r--r--  2.0 unx     4103 b- defN 23-Mar-21 02:13 intelliw/utils/crontab.py
 -rw-r--r--  2.0 unx     6075 b- defN 24-Apr-30 01:35 intelliw/utils/debug_controller.py
 -rw-r--r--  2.0 unx     1983 b- defN 24-Apr-30 03:33 intelliw/utils/exception.py
 -rw-r--r--  2.0 unx     2748 b- defN 23-Nov-17 06:25 intelliw/utils/gen_model_cfg.py
 -rw-r--r--  2.0 unx     2126 b- defN 23-Dec-28 10:51 intelliw/utils/global_val.py
 -rw-r--r--  2.0 unx       44 b- defN 24-Jan-17 03:33 intelliw/utils/health_check.py
 -rw-r--r--  2.0 unx     2916 b- defN 24-Feb-28 08:48 intelliw/utils/hijack_function.py
--rw-r--r--  2.0 unx     1049 b- defN 24-Jan-22 08:23 intelliw/utils/iprofile.py
--rw-r--r--  2.0 unx    13632 b- defN 24-Apr-09 09:22 intelliw/utils/iuap_request.py
--rw-r--r--  2.0 unx     4433 b- defN 24-Mar-19 03:30 intelliw/utils/logger.py
--rw-r--r--  2.0 unx     6740 b- defN 24-Apr-09 09:22 intelliw/utils/message.py
--rw-r--r--  2.0 unx     6240 b- defN 24-Apr-09 11:39 intelliw/utils/storage_service.py
--rw-r--r--  2.0 unx     7354 b- defN 24-Apr-30 03:33 intelliw/utils/util.py
+-rw-r--r--  2.0 unx     1897 b- defN 24-May-06 10:10 intelliw/utils/iprofile.py
+-rw-r--r--  2.0 unx    14423 b- defN 24-May-21 03:00 intelliw/utils/iuap_request.py
+-rw-r--r--  2.0 unx     4440 b- defN 24-May-16 09:09 intelliw/utils/logger.py
+-rw-r--r--  2.0 unx    48528 b- defN 24-May-07 12:47 intelliw/utils/memory_profiler.py
+-rw-r--r--  2.0 unx     6764 b- defN 24-May-10 02:34 intelliw/utils/message.py
+-rw-r--r--  2.0 unx     6240 b- defN 24-May-06 10:07 intelliw/utils/storage_service.py
+-rw-r--r--  2.0 unx     7475 b- defN 24-May-11 02:59 intelliw/utils/util.py
 -rw-r--r--  2.0 unx      346 b- defN 24-Apr-09 09:22 intelliw/utils/yaml_downloader.py
--rw-r--r--  2.0 unx     9180 b- defN 24-Feb-28 08:49 intelliw/utils/yms_downloader.py
+-rw-r--r--  2.0 unx     8873 b- defN 24-May-16 09:09 intelliw/utils/yms_downloader.py
 -rw-r--r--  2.0 unx     1163 b- defN 24-Feb-28 08:49 intelliw/utils/aiocache/__init__.py
 -rw-r--r--  2.0 unx    20436 b- defN 24-Feb-28 08:49 intelliw/utils/aiocache/base.py
 -rw-r--r--  2.0 unx      829 b- defN 24-Feb-29 03:12 intelliw/utils/aiocache/common.py
 -rw-r--r--  2.0 unx    19811 b- defN 24-Mar-01 07:29 intelliw/utils/aiocache/decorators.py
 -rw-r--r--  2.0 unx       44 b- defN 24-Feb-28 08:49 intelliw/utils/aiocache/exceptions.py
 -rw-r--r--  2.0 unx     9070 b- defN 24-Feb-28 08:49 intelliw/utils/aiocache/factory.py
 -rw-r--r--  2.0 unx     6457 b- defN 24-Feb-28 08:49 intelliw/utils/aiocache/lock.py
@@ -89,18 +90,18 @@
 -rw-r--r--  2.0 unx     2268 b- defN 24-Jan-17 03:33 intelliw/utils/colorlog/escape_codes.py
 -rw-r--r--  2.0 unx     7791 b- defN 24-Jan-17 03:33 intelliw/utils/colorlog/formatter.py
 -rw-r--r--  2.0 unx     2212 b- defN 24-Jan-17 03:33 intelliw/utils/colorlog/wrappers.py
 -rw-r--r--  2.0 unx      466 b- defN 22-Nov-11 07:28 intelliw/utils/database/__init__.py
 -rw-r--r--  2.0 unx     3253 b- defN 22-Nov-24 06:58 intelliw/utils/database/connection.py
 -rw-r--r--  2.0 unx     2023 b- defN 22-Nov-11 07:28 intelliw/utils/database/proxy.py
 -rw-r--r--  2.0 unx     2605 b- defN 22-Nov-11 07:28 intelliw/utils/database/schema.py
--rw-r--r--  2.0 unx      124 b- defN 24-Apr-11 09:04 intelliw/utils/intelliwapi/__init__.py
+-rw-r--r--  2.0 unx      179 b- defN 24-May-11 02:59 intelliw/utils/intelliwapi/__init__.py
 -rw-r--r--  2.0 unx      892 b- defN 24-Apr-11 09:04 intelliw/utils/intelliwapi/context.py
 -rw-r--r--  2.0 unx     3158 b- defN 24-Apr-30 03:33 intelliw/utils/intelliwapi/gunicorn_server.py
--rw-r--r--  2.0 unx      471 b- defN 24-Apr-11 09:04 intelliw/utils/intelliwapi/request.py
+-rw-r--r--  2.0 unx      602 b- defN 24-May-11 02:59 intelliw/utils/intelliwapi/request.py
 -rw-r--r--  2.0 unx      547 b- defN 24-Apr-11 09:04 intelliw/utils/intelliwapi/response.py
 -rw-r--r--  2.0 unx     3883 b- defN 24-Apr-15 02:22 intelliw/utils/intelliwapi/workers.py
 -rw-r--r--  2.0 unx      104 b- defN 24-Apr-24 02:01 intelliw/utils/logs/iw-algo-fx-framework.log
 -rw-r--r--  2.0 unx        0 b- defN 24-Apr-24 02:01 intelliw/utils/logs/iw-algo-fx-user.log
 -rw-r--r--  2.0 unx      108 b- defN 24-Apr-24 02:01 intelliw/utils/logs/iw-algo-fx.log
 -rw-r--r--  2.0 unx     2513 b- defN 24-Mar-01 07:22 intelliw/utils/redis/__init__.py
 -rw-r--r--  2.0 unx      245 b- defN 24-Feb-28 08:49 intelliw/utils/redis/common.py
@@ -109,14 +110,14 @@
 -rw-r--r--  2.0 unx     1315 b- defN 24-Feb-28 08:49 intelliw/utils/redis/test.py
 -rw-r--r--  2.0 unx      636 b- defN 24-Feb-22 09:03 intelliw/utils/redis/logs/iw-algo-fx-framework.log
 -rw-r--r--  2.0 unx        0 b- defN 24-Feb-22 08:49 intelliw/utils/redis/logs/iw-algo-fx-user.log
 -rw-r--r--  2.0 unx     1724 b- defN 24-Feb-22 11:56 intelliw/utils/redis/logs/iw-algo-fx.log
 -rw-r--r--  2.0 unx      200 b- defN 23-Apr-04 02:49 intelliw/utils/spark_process/__init__.py
 -rw-r--r--  2.0 unx    26154 b- defN 23-Nov-17 06:25 intelliw/utils/spark_process/engine.py
 -rw-r--r--  2.0 unx     4420 b- defN 23-Apr-04 02:49 intelliw/utils/spark_process/spark.py
--rw-r--r--  2.0 unx    35147 b- defN 24-Apr-30 03:39 intelliw-2.1.0.dist-info/LICENCE
--rw-r--r--  2.0 unx     4940 b- defN 24-Apr-30 03:39 intelliw-2.1.0.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-Apr-30 03:39 intelliw-2.1.0.dist-info/WHEEL
--rw-r--r--  2.0 unx       63 b- defN 24-Apr-30 03:39 intelliw-2.1.0.dist-info/entry_points.txt
--rw-r--r--  2.0 unx        9 b- defN 24-Apr-30 03:39 intelliw-2.1.0.dist-info/top_level.txt
--rw-rw-r--  2.0 unx    10711 b- defN 24-Apr-30 03:39 intelliw-2.1.0.dist-info/RECORD
-120 files, 652210 bytes uncompressed, 193411 bytes compressed:  70.3%
+-rw-r--r--  2.0 unx    35147 b- defN 24-May-21 03:00 intelliw-2.1.1.dist-info/LICENCE
+-rw-r--r--  2.0 unx     4940 b- defN 24-May-21 03:00 intelliw-2.1.1.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-May-21 03:00 intelliw-2.1.1.dist-info/WHEEL
+-rw-r--r--  2.0 unx       63 b- defN 24-May-21 03:00 intelliw-2.1.1.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx        9 b- defN 24-May-21 03:00 intelliw-2.1.1.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx    10802 b- defN 24-May-21 03:00 intelliw-2.1.1.dist-info/RECORD
+121 files, 704262 bytes uncompressed, 207314 bytes compressed:  70.6%
```

## zipnote {}

```diff
@@ -195,14 +195,17 @@
 
 Filename: intelliw/utils/iuap_request.py
 Comment: 
 
 Filename: intelliw/utils/logger.py
 Comment: 
 
+Filename: intelliw/utils/memory_profiler.py
+Comment: 
+
 Filename: intelliw/utils/message.py
 Comment: 
 
 Filename: intelliw/utils/storage_service.py
 Comment: 
 
 Filename: intelliw/utils/util.py
@@ -336,26 +339,26 @@
 
 Filename: intelliw/utils/spark_process/engine.py
 Comment: 
 
 Filename: intelliw/utils/spark_process/spark.py
 Comment: 
 
-Filename: intelliw-2.1.0.dist-info/LICENCE
+Filename: intelliw-2.1.1.dist-info/LICENCE
 Comment: 
 
-Filename: intelliw-2.1.0.dist-info/METADATA
+Filename: intelliw-2.1.1.dist-info/METADATA
 Comment: 
 
-Filename: intelliw-2.1.0.dist-info/WHEEL
+Filename: intelliw-2.1.1.dist-info/WHEEL
 Comment: 
 
-Filename: intelliw-2.1.0.dist-info/entry_points.txt
+Filename: intelliw-2.1.1.dist-info/entry_points.txt
 Comment: 
 
-Filename: intelliw-2.1.0.dist-info/top_level.txt
+Filename: intelliw-2.1.1.dist-info/top_level.txt
 Comment: 
 
-Filename: intelliw-2.1.0.dist-info/RECORD
+Filename: intelliw-2.1.1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## intelliw/__init__.py

```diff
@@ -4,15 +4,15 @@
 LastEditors: Hexu
 LastEditTime: 2023-05-22 14:00:18
 FilePath: /iw-algo-fx/intelliw/__init__.py
 Description: intelliw
 '''
 # coding: utf-8
 import sys
-__version__ = "2.1.0"
+__version__ = "2.1.1"
 
 logo = f"""\033[92m
 -------------------------------------------------------------
          ⓐ                    _    _    ⓘ
          _  _ __    _    ___ | |  | |   _  _     _
         | || '_ \ _| |_ / _ \| |  | |  | |\ \ _ / /
         | || | | |_   _|  __/| |__| |__| | \  _  /
```

## intelliw/config/config.py

```diff
@@ -108,15 +108,15 @@
 
 # 推理服务
 TOKEN = ''  # API 响应 token
 API_EXTRAINFO = True  # API 响应包含 extra info
 INFER_MULTI_PROCESS = False  # 是否多进程
 INFER_MULTI_THREAD_COUNT = 0  # 自定义线程数
 INFER_MULTI_PROCESS_COUNT = 0  # 自定义进程数
-INFER_MAX_TASK_RATIO = 2  # 最大任务数是几倍的线程数
+INFER_MAX_TASK_RATIO = 3  # 最大任务数是几倍的线程数
 
 # 云存储相关
 STORAGE_SERVICE_PATH = ''
 STORAGE_SERVICE_URL = ''
 FILE_UP_TYPE = ""  # 对应的类型 AliOss/Minio
 
 # AuthSDK
```

## intelliw/core/pipeline.py

```diff
@@ -6,25 +6,27 @@
 import threading
 import traceback
 import importlib
 import os
 import time
 import importlib.util
 import sys
+from concurrent.futures import ThreadPoolExecutor
 from inspect import signature
 from typing import Tuple
 from intelliw.config.cfg_parser import load_config
 from intelliw.datasets.datasets import DataSets, MultipleDataSets
 from intelliw.utils import exception, yms_downloader
 from intelliw.utils.exception import ModelLoadException, LimitConcurrencyError
 from intelliw.utils import prepare_algorithm_parameters, prepare_model_parameters, import_code, get_first_element
 from intelliw.utils.check_algorithm_py import is_valid_algorithm
 import intelliw.utils.message as message
 from intelliw.core.recorder import Recorder
 from intelliw.core.linkserver import linkserver
+from intelliw.utils import iprofile
 from intelliw.utils.logger import _get_framework_logger, _get_algorithm_logger
 from intelliw.config import config
 from intelliw.utils.global_val import gl
 from intelliw import functions
 from intelliw.core.al_decorator import make_decorators_server
 from intelliw.utils import hijack_function
 
@@ -74,16 +76,16 @@
         self.feature_transforms = None  # 内置针对总体数据结构处理的  特征工程
         self.recorder = reporter if isinstance(reporter, Recorder) else Recorder(
             reporter)
         self.instance = None
         self.custom_router = []
         self.alg_describe = ''
         self.background_tasks = set()
-        self.async_executor = None
-        self.max_task_count = 999
+        self.async_executor = ThreadPoolExecutor(999)
+        self.max_wait_task = 999
         self.thread_data_pool = {}
 
     @staticmethod
     def _check_certified_image():
         # 检查是不是规范化镜像（onnx）
         if any([importlib.util.find_spec("torch"),
                 importlib.util.find_spec("paddle"),
@@ -499,67 +501,93 @@
         except Exception as e:
             self.raise_exception(
                 message.err_train, e, is_framework_error=False
             )
 
     async def _infer_process(self, data, request, func='infer', need_feature=False):
 
-        if self.async_executor._work_queue.qsize() >= self.max_task_count:
+        if self.async_executor._work_queue.qsize() >= self.max_wait_task:
             error_msg = (f"Exceeded concurrency limit, "
-                         f"Max task limit: {self.max_task_count * config.INFER_MULTI_PROCESS_COUNT}")
+                         f"Max wait task limit: {self.max_wait_task * config.INFER_MULTI_PROCESS_COUNT}")
             logger.warning(error_msg)
             raise LimitConcurrencyError(error_msg)
 
         loop = asyncio.get_event_loop()
 
         if need_feature:  # 前处理
             data = await loop.run_in_executor(
                 self.async_executor, self._feature_helper, Const.pre_predict,
                 self._transform_helper(Const.pre_predict, data, False)
             )
 
+        # profile
+        check_profile = request.query.get('intelliw_profile')
+        check_mprofile = request.query.get('intelliw_mprofile')
+
         # 推理
         self.instance.request = request
         infer_func = getattr(self.instance, func)
         arg = [data] if infer_func.__code__.co_argcount > 1 else []  # 获取函数参数数量
 
         if not inspect.iscoroutinefunction(infer_func):
             def infer_process(*a):
+                # 数据池
                 if self.thread_data_pool:
                     t = threading.currentThread().ident
                     self.instance.request.context = self.thread_data_pool.get(t)
-                return infer_func(*a)
+
+                if check_profile:  # 性能检测
+                    return iprofile.performance_profile(infer_func, *a)
+                elif check_mprofile:  # 内存检测
+                    try:
+                        from intelliw.utils import memory_profiler
+                    except ImportError as e:
+                        return {"result": e}
+                    memory_usage, res = memory_profiler.memory_usage(
+                        (infer_func, *a), retval=True,
+                        include_children=True,
+                        interval=.2, max_iterations=1)
+                    return {"result": res, "profile": memory_usage}
+                else:
+                    return infer_func(*a)
 
             # 非异步算法异步执行
             result = await loop.run_in_executor(
                 self.async_executor, infer_process, *arg
             )
         else:
             # 异步算法默认已经做了从头到尾的异步处理
             # 出现阻塞问题，是算法对async await理解不够透彻
-            result = await infer_func(*arg)
+            if check_profile:
+                result = await iprofile.async_performance_profile(infer_func, *arg)
+            else:
+                result = await infer_func(*arg)
 
         if need_feature:  # 后处理
             result = await loop.run_in_executor(
                 self.async_executor, self._transform_helper, Const.post_predict, result, False
             )
         return result
 
     async def infer(self, data, request, func='infer', need_feature=True):
         """
         推理入口
         """
         try:
-            logger.debug("receiving predict data %s", data)
+            start_t = time.time()
             result = await self._infer_process(
                 data, request, func, need_feature
             )
+            logger.info(
+                f'{request.method} {request.url.path}   function: {func}   time: \033[33m{time.time() - start_t}s\033[0m '
+            )
             return result, None
         except LimitConcurrencyError as e:
-            return {"code": 500, "msg": f"inference error: {e}"}, None
+            msg = f"inference error: {e}"
+            return {"code": 5001, "msg": msg}, msg
         except Exception as e:
             stack_info = traceback.format_exc()
             logger.error("推理错误 %s, stack:\n%s", e, stack_info)
             return None, f"inference error: {e}"
 
     def transform_call_wrapper(self, src, func, params):
         """
```

## intelliw/datasets/datasource_large_model.py

```diff
@@ -83,14 +83,20 @@
         self._gen_corpora_dir()
 
         start_time = time.time()
         # 切分函数的缓存, 减少切分次数
         spliter_cache = {}
         # io_reader 数据集写入文件io
         dataset_list = [[], [], []]
+        if DataSourceLMCorpora.dataset_count > 1:
+            for i in range(DataSourceLMCorpora.dataset_class):
+                file_path = os.path.join(self.dirpath[i], self.file_name[i])
+                if os.path.exists(file_path):
+                    with open(file_path, "r") as fp:
+                        dataset_list[i] = json.load(fp)
 
         # 进行多文件循环数据集拆分
         for epoch, part in enumerate(self._get_reader()):
             # split_mode 根据拆分模式进行处理
             if split_mode:
                 self.random.shuffle(part)
             part_count = len(part)
```

## intelliw/interface/apihandler.py

```diff
@@ -3,15 +3,15 @@
 Date: 2021-10-25 15:20:34
 LastEditTime: 2023-05-24 15:15:48
 LastEditors: Hexu
 Description: api处理函数
 FilePath: /iw-algo-fx/intelliw/interface/apihandler.py
 '''
 import asyncio
-import queue
+import time
 import types
 from concurrent.futures import ThreadPoolExecutor
 
 import starlette.datastructures
 from fastapi import FastAPI, Request as FARequest, Response as FAResponse
 from fastapi.responses import StreamingResponse
 
@@ -195,15 +195,15 @@
             initializer = threading_init
             initargs = (
                 self.infer.pipeline.thread_data_pool,
                 self.CONTEXT_OBJECT.func,
                 *self.CONTEXT_OBJECT.args
             )
 
-        self.infer.pipeline.max_task_count = config.INFER_MAX_TASK_RATIO * thread
+        self.infer.pipeline.max_wait_task = min(999, max(2, config.INFER_MAX_TASK_RATIO * thread))
         self.infer.pipeline.async_executor = ThreadPoolExecutor(
             thread, initializer=initializer, initargs=initargs, thread_name_prefix="IntelliwServerPool")
 
     def _fastapi_server(self):
         worker, thread = util.get_worker_count(
             config.CPU_COUNT,
             config.INFER_MULTI_THREAD_COUNT,
@@ -222,15 +222,16 @@
         else:
             # 默认模式
             server = gunicorn_server.UvicornServer(
                 self.app,
                 "0.0.0.0", self.port
             )
 
-        logger.info("\033[34mServer init success, workers: %s, threads: %s \033[0m", worker, thread)
+        logger.info("\033[34mServer init success, workers: %s, threads: %s, max wait task: %s \033[0m",
+                    worker, thread, self.infer.pipeline.max_wait_task)
         server.run()
 
     def run(self):
         """
         start server
         """
         self._eureka_server()
@@ -254,14 +255,16 @@
             Tuple[Union[Dict[str, Any], APIResponse], bool]: Parsed request data and success flag.
         """
         is_ok = True
         req_data = {}
 
         try:
             self.infer_request.header = self.fa_request.headers
+            self.infer_request.method = self.fa_request.method
+            self.infer_request.url = self.fa_request.url
 
             # Query parameters
             self.infer_request.query = self.fa_request.query_params._dict
 
             # Request body
             self.infer_request.body = await self.fa_request.body()
             content_type = self.infer_request.header.get('Content-Type', "").strip()
@@ -273,15 +276,15 @@
                 for k, v in getattr(form_data, "_list"):
                     if isinstance(v, starlette.datastructures.UploadFile):
                         self.infer_request.files[k] = v
                     _data = self.infer_request.form.get(k, [])
                     _data.append(v)
                     self.infer_request.form[k] = _data
                 req_data = self.infer_request.form
-            elif content_type.startswith('application/json'):
+            elif content_type.startswith('application/json') and self.infer_request.body:
                 req_data = await self.fa_request.json()
                 self.infer_request.json = req_data
             elif self.infer_request.body:
                 try:
                     req_data = await self.fa_request.json()
                     self.infer_request.json = req_data
                 except json.decoder.JSONDecodeError:
@@ -309,15 +312,15 @@
             result, emsg = await self.infer(data, func, need_feature, )
             if emsg is None:
                 if is_stream and type(result) in (
                         types.GeneratorType, types.AsyncGeneratorType):
                     return result, True
                 resp = message.APIResponse(200, "api", '', result)
             else:
-                resp = message.APIResponse(500, "api", emsg, emsg)
+                resp = message.APIResponse(500, "api", emsg, result)
         except Exception as e:
             logger.error(traceback.format_exc())
             msg = f"API服务处理推理数据错误 {e}"
             resp = message.APIResponse(500, "api", msg, msg)
         return resp, False
 
     @aiocache.cached(key_builder=aiocache.common.key_builder,
@@ -355,8 +358,9 @@
 
     # 进行推理处理
     if is_ok:
         func, need_feature = get_api_config(request)
         result, is_stream = await base.response_process(result, func, need_feature)
         if is_stream:
             return StreamingResponse(result, media_type="text/event-stream")
+
     return FAResponse(content=str(result), media_type="application/json")
```

## intelliw/interface/batchjob.py

```diff
@@ -10,31 +10,26 @@
 from intelliw.datasets.datasets import get_dataset, get_datasource_writer, \
     DataSets, MultipleDataSets
 from intelliw.core.recorder import Recorder
 from intelliw.core.infer import Infer
 from intelliw.utils import message
 import uvicorn
 from intelliw.datasets.datasource_base import DataSourceReaderException, DataSourceWriterException
-from intelliw.utils import get_json_encoder
+from intelliw.utils import get_json_encoder, intelliwapi
 from intelliw.config import config
 from intelliw.utils.logger import _get_framework_logger
 
 logger = _get_framework_logger()
 
 batchjob_infer = "batchjob-infer"
 
 INFER_CONTROLLER: Infer = None  # type: ignore
 intelliw_setting = {}
 
 
-class Request:
-    def __init__(self, batch_params={}) -> None:
-        self.batch_params = batch_params
-
-
 def get_batch_msg(issuccess, msg, status=True, starttime=None, user_param={}, system_param={}):
     """
     批处理上报信息，inferTaskStatus 不为空，会被记录为一次调用，标识一次批处理的状态
     """
     infer_task_status = []
     if status:
         infer_task_status = [
@@ -99,15 +94,15 @@
     start_time = int(time.time() * 1000)
     result, stack_info, info = None, None, ""
     try:
         # 输入
         alldata = input()
 
         # 批处理
-        req = Request(user_param)
+        req = intelliwapi.Request(user_param=user_param)
         global INFER_CONTROLLER
         result = await INFER_CONTROLLER.pipeline._infer_process(alldata, req)
         logger.info('批处理处理结果 %s', result)
 
         # 输出
         output(result)
     except DataSourceReaderException as e:
```

## intelliw/utils/iprofile.py

```diff
@@ -1,38 +1,73 @@
 import io
 import os
 import sys
 import tempfile
+import time
 from functools import wraps
+import cProfile
+import pstats
 
-from intelliw.utils.storage_service import StorageService
+from intelliw.utils.storage_service import StorageService, FileTransferDevice
+from intelliw.utils.logger import _get_framework_logger
 
+logger = _get_framework_logger()
 
-def performance_profile(filepath=None):
-    import cProfile
-    import pstats
 
+def _pre():
+    logger.warning("performance profile request...")
+    pr = cProfile.Profile()
+    pr.enable()
+    return pr
+
+
+def _post(pr):
+    pr.disable()
+    with io.StringIO() as s:
+        sort_by = pstats.SortKey.CUMULATIVE
+        ps = pstats.Stats(pr, stream=s).sort_stats(sort_by)
+        ps.print_stats()
+        profile = s.getvalue()
+
+    logger.warning(f"\n{profile}")
+
+    """
+    上传云服务， 通过
+    >>> flameprof pipeline.prof > pipeline.svg
+    查看火焰图
+    """
+    with tempfile.NamedTemporaryFile() as tmp:
+        tmp_file = tmp.name + '.prof'
+        pr.dump_stats(tmp_file)
+        fd = FileTransferDevice(
+            tmp_file, "profile_result", filename=f"result-{int(time.time())}.prof"
+        )
+    raw_stats = fd.curkey
+    return profile, raw_stats
+
+
+async def async_performance_profile(func, *args, **kwargs):
+    pr = _pre()
+    result = await func(*args, **kwargs)
+    profile, raw_stats = _post(pr)
+    return {"result": result, "profile": profile, "raw_stats": raw_stats}
+
+
+def performance_profile(func, *args, **kwargs):
+    pr = _pre()
+    result = func(*args, **kwargs)
+    profile, raw_stats = _post(pr)
+    return {"result": result, "profile": profile, "raw_stats": raw_stats}
+
+
+def performance_profile_wrapper(filepath=None):
     def wrapper(function):
         @wraps(function)
         def inner(*args, **kwargs):
-            pr = cProfile.Profile()
-            pr.enable()
-
+            pr = _pre()
             result = function(*args, **kwargs)
-
-            pr.disable()
-            s = io.StringIO()
-            sort_by = pstats.SortKey.CUMULATIVE
-            ps = pstats.Stats(pr, stream=s).sort_stats(sort_by)
-            ps.print_stats()
-            sys.stderr.write("{}\n".format(s.getvalue()))
-            if filepath:
-                curkey = os.path.join(filepath, "pipeline.prof")
-                with tempfile.NamedTemporaryFile() as temp:
-                    filename = temp.name + '.prof'
-                    pr.dump_stats(filename)
-                    StorageService(curkey, "upload").upload(filename)
-            return result
+            profile, raw_stats = _post(pr)
+            return {"result": result, "profile": profile, "raw_stats": raw_stats}
 
         return inner
 
     return wrapper
```

### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

## intelliw/utils/iuap_request.py

```diff
@@ -149,118 +149,126 @@
                 speed = download_content_size - temp_size
                 if idx % 5 == 0:
                     report_hook(plan, speed)
                 temp_size = download_content_size
 
 
 def get(url: str, headers: dict = None, params: dict = None, timeout: float = DEFAULT_TIMEOUT,
-        auth_type=AuthType.AuthSDK, ak=None, ase=None) -> Response:
+        auth_type=AuthType.AuthSDK, ak=None, ase=None, retry=True) -> Response:
     """
     get request
 
     :param auth_type: 是否需要健全 0 不需要 1 authsdk 2 yht
     :param timeout: request timeout
     :param url: request url
     :param headers: request headers
     :param params: request url params
     :param ak: 用户自定义access key
     :param ase: 用户自定义access secret
+    :param retry: 重试, 0或false为不重试，可以设置重试次数
     :return: Response
     """
-    return sign_and_request(url, 'GET', headers, params, timeout=timeout, auth_type=auth_type, ak=ak, ase=ase)
+    return sign_and_request(url, 'GET', headers, params, timeout=timeout, auth_type=auth_type, ak=ak, ase=ase,
+                            retry=retry)
 
 
 def post_json(url: str, headers: dict = None, params: dict = None, json: object = None,
-              timeout: float = DEFAULT_TIMEOUT, auth_type=AuthType.AuthSDK, ak=None, ase=None) -> Response:
+              timeout: float = DEFAULT_TIMEOUT, auth_type=AuthType.AuthSDK, ak=None, ase=None,
+              retry: [bool, int] = True) -> Response:
     """
     post request, send data as json
 
 
     :param auth_type: 是否需要健全 0 不需要 1 authsdk 2 yht
     :param timeout: request timeout
     :param url: request url
     :param headers: request headers
     :param params: request url parameters
     :param json: request body. if data is not `str`, it will be serialized as json.
     :param ak: 用户自定义access key
     :param ase: 用户自定义access secret
+    :param retry: 重试, 0或false为不重试，可以设置重试次数
     :return: Response
     """
 
     if headers is None:
         headers = {}
     headers['Content-type'] = 'application/json; charset=UTF-8'
     return sign_and_request(url, 'POST', headers, params, json=json,
-                            timeout=timeout, auth_type=auth_type, ak=ak, ase=ase)
+                            timeout=timeout, auth_type=auth_type, ak=ak, ase=ase, retry=retry)
 
 
 def post(url: str, headers: dict = None, params: dict = None, data: object = None,
-         timeout: float = DEFAULT_TIMEOUT, auth_type=AuthType.AuthSDK, ak=None, ase=None) -> Response:
+         timeout: float = DEFAULT_TIMEOUT, auth_type=AuthType.AuthSDK, ak=None, ase=None,
+         retry: [bool, int] = True) -> Response:
     """
     post request, send data
 
 
     :param auth_type: 是否需要健全 0 不需要 1 authsdk 2 yht
     :param timeout: request timeout
     :param url: request url
     :param headers: request headers
     :param params: request url parameters
     :param data: request body. if data is not `str`, it will be serialized as json.
     :param ak: 用户自定义access key
     :param ase: 用户自定义access secret
+    :param retry: 重试, 0或false为不重试，可以设置重试次数
     :return: Response
     """
 
     if headers is None:
         headers = {}
     return sign_and_request(url, 'POST', headers, params, data=data,
-                            timeout=timeout, auth_type=auth_type, ak=ak, ase=ase)
+                            timeout=timeout, auth_type=auth_type, ak=ak, ase=ase, retry=retry)
 
 
 def put_file(url: str, headers: dict = None, params: dict = None, data: object = None,
-             timeout: float = DEFAULT_TIMEOUT, auth_type=AuthType.No, ak=None, ase=None) -> Response:
+             timeout: float = DEFAULT_TIMEOUT, auth_type=AuthType.No, ak=None, ase=None,
+             retry: [bool, int] = True) -> Response:
     """
     put file
     """
     if headers is None:
         headers = {'Content-Type': 'application/octet-stream'}
     return sign_and_request(url, 'PUT', headers, params, data=data,
-                            timeout=timeout, auth_type=auth_type, ak=ak, ase=ase)
+                            timeout=timeout, auth_type=auth_type, ak=ak, ase=ase, retry=retry)
 
 
 def sign_and_request(url: str,
                      method: str = 'GET',
                      headers: dict = None,
                      params: dict = None,
                      data: bytes = None,
                      json: dict = None,
                      timeout: float = DEFAULT_TIMEOUT,
                      auth_type=AuthType.AuthSDK,
-                     ak=None, ase=None) -> Response:
+                     ak=None, ase=None, retry=True) -> Response:
     """
     sign and do request
 
     :param url: request url, without query
     :param method: Http request method, GET, POST...
     :param headers: request headers
     :param params: parameters will be sent as url parameters. Also used to generate signature if sign_params is None.
     :param data: request body
     :param json: Request body in Json format
     :param timeout: url access timeout
     :param auth_type: 是否需要健全 0 不需要 1 authsdk 2 yht
     :param ak: 用户自定义access key
     :param ase: 用户自定义access secret
+    :param retry: 重试, 0或false为不重试，可以设置重试次数
     :return: response body
     """
     if headers is None:
         headers = {}
 
     # auth
     sign(url, params, headers, auth_type, ak=ak, ase=ase)
-    return __do_request(url, method, headers, params, data, json, timeout=timeout, auth_type=auth_type)
+    return __do_request(url, method, headers, params, data, json, timeout=timeout, auth_type=auth_type, retry=retry)
 
 
 def sign(url: str, params: dict, headers: dict, auth_type=AuthType.AuthSDK, ak=None, ase=None, refresh=False):
     if ak is not None and ase is not None:
         auth_type = AuthType.AuthSDK
 
     if has_jwt_package and auth_type == AuthType.AuthSDK:
@@ -357,51 +365,56 @@
 
 def __do_request(url: str,
                  method: str = 'GET',
                  headers: dict = {},
                  params: dict = {},
                  data: bytes = None,
                  json: object = None,
-                 timeout: float = DEFAULT_TIMEOUT, auth_type=AuthType.No) -> Response:
+                 timeout: float = DEFAULT_TIMEOUT,
+                 auth_type=AuthType.No, retry: [bool, int] = True) -> Response:
     # header format
     if headers is None:
         headers = {}
 
     headers = {
         **headers,
         **{'X-tenantId': config.TENANT_ID,
            'tenant_id': config.TENANT_ID,
            'tenantId': config.TENANT_ID,
            'instanceID': config.INSTANCE_ID,
            }
     }
 
-    for i in range(1, 5):
+    retry_count = 4
+    if type(retry) == int and retry > 0:
+        retry_count = retry
+
+    for i in range(1, retry_count + 1):
         try:
             if i == 2:
                 url = replace_url(url)
             resp = requests.request(
                 method=method, url=url, params=params, data=data,
                 json=json, headers=headers, verify=False, timeout=timeout
             )
             body = resp.text
             # 验签失败重试
             if "<title>登录</title>" in body:
                 raise SignError("跳转登陆页, 请重新登录", f"Token验证未通过, 跳转登陆页")
             return Response(resp)
         except (requests.exceptions.RequestException, SignError) as e:
-            if i == 4:
+            if not retry or i == retry_count:
                 raise e
-            time.sleep(i * 2)
+            time.sleep(2)
             headers, _ = sign(url, params, headers, auth_type, refresh=True)
             try:
                 body = e.response.text if hasattr(e.response, "text") else e.response
             except:
                 body = ""
-            logger.error(
+            logger.warning(
                 "request retry time: %s, url: %s, body: %s, error: %s",
                 i, url, body, e)
 
 
 class SignError(Exception):
     def __init__(self, body="", msg=""):
         self.response = body
@@ -409,7 +422,11 @@
 
     def __str__(self):
         return self.msg
 
     @staticmethod
     def ignore_stack():
         return True
+
+
+if __name__ == '__main__':
+    post_json("http://www.google.com", timeout=1, retry=4)
```

## intelliw/utils/logger.py

```diff
@@ -85,15 +85,15 @@
                 time_file_handler = logging.handlers.RotatingFileHandler(
                     os.path.join(log_path, filename),
                     mode='a',
                     maxBytes=1024 * 1024 * 100,
                     backupCount=30)
                 formatter = ColoredFormatter(
                     format, datefmt=default_data_format)
-                time_file_handler.setLevel(level)
+                time_file_handler.setLevel(logging.INFO)
                 time_file_handler.setFormatter(formatter)
                 logger.addHandler(time_file_handler)
         return logger
 
 
 def _get_framework_logger():
     global framework_logger
```

## intelliw/utils/message.py

```diff
@@ -48,18 +48,18 @@
     def _format(self):
         if config.API_EXTRAINFO:
             return {
                 "extrainfo": {
                     "status": self.code,
                     "message": self.msg,
                 },
-                "data": self.data
+                "data": self.data or self.msg
             }
         else:
-            return self.data
+            return self.data or self.msg
 
     def __str__(self):
         return json.dumps(self._format(), cls=get_json_encoder(), ensure_ascii=False)
 
     def __call__(self):
         return self._format()
```

## intelliw/utils/util.py

```diff
@@ -1,13 +1,14 @@
 #!/usr/bin/env python
 # coding: utf-8
 import datetime
 import inspect
 import math
 import string
+import traceback
 import types
 import json
 import os
 import zipfile
 from random import Random
 
 from intelliw.config import config
@@ -188,18 +189,21 @@
 def get_worker_count(cpus, threads, is_multi_precess):
     worker, thread = 1, number_of_threads(cpus)
     if is_multi_precess:
         worker = number_of_workers(config.CPU_COUNT)
 
     # 自定义线程数
     if threads:
-        thread = threads
-        if worker > 1:
-            thread = math.floor(thread / worker)
-        thread = min(64, max(1, thread))
+        try:
+            thread = int(threads)
+            if worker > 1:
+                thread = math.floor(thread / worker)
+            thread = min(128, max(1, thread))
+        except Exception as e:
+            traceback.print_exc()
 
     return worker, thread
 
 
 def number_of_workers(core: str = ''):
     core = str(core).lower()
     num_core = 1
```

## intelliw/utils/yms_downloader.py

```diff
@@ -110,57 +110,55 @@
             except Exception as e:
                 logger.error("set yms environ error: {}, Key:{}, Value:{}".format(e, k, v))
 
             if self.local_cache is not None:
                 self.local_cache.write(f"{k}={v}\n")
 
     def init_redis(self, redis):
-        ai_console_redis_code = "iuap-aip-console-redis"
-        if redis:
+        if not redis:
+            return
 
-            pool_name = None
-            database = None
-            for c in redis['clients']:
-                if c['name'] == ai_console_redis_code:
-                    pool_name = c['pool']
-                    database = c.get('database')
+        for c in redis['clients']:
+            pool_name = c['pool']
+            database = c.get('database')
+            redis_code = c['name']
 
             pool_info = None
             for p in redis['pools']:
                 if p['name'] == pool_name:
                     pool_info = p
 
             if pool_info:
                 if pool_info['type'] == 'single':
-                    os.environ[f'{ai_console_redis_code}_REDIS_URL'] = f"{pool_info['host']}:{pool_info['port']}"
+                    os.environ[f'{redis_code}_REDIS_URL'] = f"{pool_info['host']}:{pool_info['port']}"
                     if self.local_cache is not None:
                         self.local_cache.write(
-                            f"{ai_console_redis_code}_REDIS_URL={pool_info['host']}:{pool_info['port']}\n")
+                            f"{redis_code}_REDIS_URL={pool_info['host']}:{pool_info['port']}\n")
                 else:
-                    os.environ[f'{ai_console_redis_code}_REDIS_URL'] = pool_info['nodes']
+                    os.environ[f'{redis_code}_REDIS_URL'] = pool_info['nodes']
                     if self.local_cache is not None:
-                        self.local_cache.write(f"{ai_console_redis_code}_REDIS_URL={pool_info['nodes']}\n")
+                        self.local_cache.write(f"{redis_code}_REDIS_URL={pool_info['nodes']}\n")
 
                 value = decode_yms_pw(pool_info.get('password', ''))
                 sentinel_value = decode_yms_pw(pool_info.get('sentinelPassword', ''))
-                os.environ[f'{ai_console_redis_code}_REDIS_TYPE'] = f"{pool_info.get('type', '')}"
-                os.environ[f'{ai_console_redis_code}_REDIS_DATABASE'] = f'{database}'
-                os.environ[f'{ai_console_redis_code}_REDIS_PASSWORD'] = value
-                os.environ[f'{ai_console_redis_code}_REDIS_SENTINEL_PASSWORD'] = sentinel_value
-                os.environ[f'{ai_console_redis_code}_REDIS_MASTER_NAME'] = f"{pool_info.get('masterName', '')}"
-                os.environ[f'{ai_console_redis_code}_REDIS_POOL_SIZE'] = f"{pool_info.get('max-idle', '')}"
+                os.environ[f'{redis_code}_REDIS_TYPE'] = f"{pool_info.get('type', '')}"
+                os.environ[f'{redis_code}_REDIS_DATABASE'] = f'{database}'
+                os.environ[f'{redis_code}_REDIS_PASSWORD'] = value
+                os.environ[f'{redis_code}_REDIS_SENTINEL_PASSWORD'] = sentinel_value
+                os.environ[f'{redis_code}_REDIS_MASTER_NAME'] = f"{pool_info.get('masterName', '')}"
+                os.environ[f'{redis_code}_REDIS_POOL_SIZE'] = f"{pool_info.get('max-idle', '')}"
 
                 if self.local_cache is not None:
-                    self.local_cache.write(f"{ai_console_redis_code}_REDIS_TYPE={pool_info.get('type', '')}\n")
-                    self.local_cache.write(f"{ai_console_redis_code}_REDIS_DATABASE={database}\n")
-                    self.local_cache.write(f"{ai_console_redis_code}_REDIS_PASSWORD={value}\n")
-                    self.local_cache.write(f"{ai_console_redis_code}_REDIS_SENTINEL_PASSWORD={sentinel_value}\n")
+                    self.local_cache.write(f"{redis_code}_REDIS_TYPE={pool_info.get('type', '')}\n")
+                    self.local_cache.write(f"{redis_code}_REDIS_DATABASE={database}\n")
+                    self.local_cache.write(f"{redis_code}_REDIS_PASSWORD={value}\n")
+                    self.local_cache.write(f"{redis_code}_REDIS_SENTINEL_PASSWORD={sentinel_value}\n")
                     self.local_cache.write(
-                        f"{ai_console_redis_code}_REDIS_MASTER_NAME={pool_info.get('masterName', '')}\n")
-                    self.local_cache.write(f"{ai_console_redis_code}_REDIS_POOL_SIZE={pool_info.get('max-idle', '')}\n")
+                        f"{redis_code}_REDIS_MASTER_NAME={pool_info.get('masterName', '')}\n")
+                    self.local_cache.write(f"{redis_code}_REDIS_POOL_SIZE={pool_info.get('max-idle', '')}\n")
 
     def __del__(self):
         self.close_file()
 
 
 yms_sys_env = YmsSysEnv()
```

## intelliw/utils/intelliwapi/__init__.py

```diff
@@ -1,5 +1,6 @@
 from contextvars import ContextVar
+from intelliw.utils.intelliwapi.request import Request
 
 _request_scope_context_storage: ContextVar[str] = ContextVar(
     "ctx", default=None
 )
```

## intelliw/utils/intelliwapi/request.py

```diff
@@ -5,17 +5,22 @@
 
 
 class Request:
     """
     intelliw server request
     """
 
-    def __init__(self) -> None:
+    def __init__(self, **kwargs) -> None:
         self.header = None
         self.json = ""
         self.query = {}
         self.form = IntelliwDict()
         self.files = {}
         self.body = ""
         self.batch_params = {}
         self.context = None
         self.raw = None
+        self.method = "GET"
+        self.url = None
+
+        for k, v in kwargs.items():
+            setattr(self, k, v)
```

## Comparing `intelliw-2.1.0.dist-info/LICENCE` & `intelliw-2.1.1.dist-info/LICENCE`

 * *Files identical despite different names*

## Comparing `intelliw-2.1.0.dist-info/METADATA` & `intelliw-2.1.1.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: intelliw
-Version: 2.1.0
+Version: 2.1.1
 Summary: An easy to start Intelligent Workshop Algorithm Framework
 Home-page: http://git.yonyou.com/iuapaipaas/iw-algo-fx
 Author: yonyou
 Author-email: yonyou@yonyou.com
 Classifier: Development Status :: 3 - Alpha
 Classifier: Programming Language :: Python :: 3.6
 Classifier: Programming Language :: Python :: 3.7
```

## Comparing `intelliw-2.1.0.dist-info/RECORD` & `intelliw-2.1.1.dist-info/RECORD`

 * *Files 4% similar despite different names*

```diff
@@ -1,36 +1,36 @@
 intelliw/.DS_Store,sha256=FWsT2V9Tu_FKYUhERgofxps-qfyeasfyNI539Pv9Cw8,10244
-intelliw/__init__.py,sha256=swUxH6knPJe_kRs7r1fYsgcl8D2HwGg-DUBx3gJrM-Y,730
+intelliw/__init__.py,sha256=qwxNsygC3fpcXyVhgUe5ayNwXVjHkAN-OjyNCc2zCE0,730
 intelliw/feature.py,sha256=wZpvnhlxzK2AAdYjEznjKuqD7Ud51d3OhWJHHbJQogg,887
 intelliw/prepare_env.sh,sha256=Fhtfhr7RoQIRZyZTwG-uHoJ7LWKLeJn4NC8Y10a-pV4,10062
 intelliw/algorithms_demo/README.md,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 intelliw/algorithms_demo/algorithm.py,sha256=El8hJacV1H1ea2a7gvroTpcHuqIareQn_Vzb4bBzp-0,5519
 intelliw/algorithms_demo/algorithm.yaml,sha256=tZXyYV-oOGWTZ2yTIrpucnZEFCLOryOFftQmpbzRo64,270
 intelliw/algorithms_demo/requirements.txt,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 intelliw/config/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 intelliw/config/cfg_parser.py,sha256=fFLRVELsZs_RVSM0Y97EWqGwWTV0kn91janqCp5WFhM,4446
-intelliw/config/config.py,sha256=CvpPJ74XdgJK-Y42kswnEUuYz1OKVYehun-pWxF2WwE,5506
+intelliw/config/config.py,sha256=rqOE_sfFZzraAbVF1newF5Gi86va2zYFHxYSke29mNg,5506
 intelliw/config/dataset_config.py,sha256=3JNAZMR78NMe6NS1NBUOiQ13cXqSs-5XcG0FByMsVDk,5460
 intelliw/core/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 intelliw/core/al_decorator.py,sha256=WQbwcxRIEIfgBNrOHD4W50lD2OUA9pcdS9MofKn3cTA,9507
 intelliw/core/custom.py,sha256=tSgtC23k5N2PAch3g5K90hObkxFxZZO3THTwZ7cLPVA,5891
 intelliw/core/infer.py,sha256=SpN50AI5qQ1a7ou7arY0tXSmtuYyeqqFLVXl8tNsZcw,744
 intelliw/core/linkserver.py,sha256=UgqJhbDV2yxs8XRYJ_jrK9XoP_zc-CIcsCxcA329FLk,9617
-intelliw/core/pipeline.py,sha256=8qow5BaoajdbmwjzMIY9dbE1ydCPOW6PGPhji1_UEac,29548
+intelliw/core/pipeline.py,sha256=kHsI5itALGqmQVymSYkyCINN8tdVuZTR9jHjhyv4_lA,30801
 intelliw/core/recorder.py,sha256=12g14UNnypwJJeaVaTqY2Nv4p7FHjrVoqyxXK7ccUko,2357
 intelliw/core/trainer.py,sha256=sBxzTxLcJuzfX2KI98y80eSiwqZBKkclKV_EmzuSwbY,903
 intelliw/datasets/__init__.py,sha256=PRq4976rCVMRI5SpeZpC9hJFxyej1P6dgw0cTE4OQEk,675
 intelliw/datasets/dataset_writer.py,sha256=9ib5qV9e5KAK3K6T0alnqgv_MB0uE-UCIJ5qMa8LzJw,9230
 intelliw/datasets/datasets.py,sha256=5Qry2WrGy8ccGRRJavwrkvw1MweppY81G9hxYZPLFPs,8669
 intelliw/datasets/datasource_base.py,sha256=nCzbHKMVzUZS99wQJ5D3YN2NAgZit3mQv9xaXlYE33k,3691
 intelliw/datasets/datasource_empty.py,sha256=CrXJP3VHT-f6BrbJppwBseuxVrdqWsMd7tETS3n9FKM,1006
 intelliw/datasets/datasource_intelliv.py,sha256=2KLuy2VJq4qev5aZR6V4PA_MgZ6Ap9Mm-sD7DDr2TnE,6847
 intelliw/datasets/datasource_iwfactorydata.py,sha256=GiWaaWslsYXsqwWX_0v04pf1e8excB6cUvzYvfhU6fw,8850
 intelliw/datasets/datasource_iwimgdata.py,sha256=rt7DelZYdf97pXq4Iz--rZgNoiEayhxHy0zWae4-x2A,15959
-intelliw/datasets/datasource_large_model.py,sha256=En5Avo5Ud5k59d_glpFLeOonb31TBqUSHjuoMepZ-3A,9096
+intelliw/datasets/datasource_large_model.py,sha256=UaOJFKJrvnSwq6hLT-ftNUtqpNd-E0gQ9YJ8J21s0vE,9441
 intelliw/datasets/datasource_local_csv.py,sha256=FsWg5DS6cn8y_eAWmg1-UZWo7pA-XeTheMbC5EpnWYU,5248
 intelliw/datasets/datasource_nlp_corpora.py,sha256=GIxpBrEdXRvnV27uXabjU6SUfLLq8YMYjxODFxPanyQ,14853
 intelliw/datasets/datasource_remote_csv.py,sha256=QB8-zZ-tJa1IGcO7v4plxph6n7K3X3IYN6vGq-HRkwg,2102
 intelliw/datasets/datasource_semantic.py,sha256=nnFp25WtQPOdM1nIk_6AR4Hx-PN5tqVcaDwADLnSSHc,7424
 intelliw/datasets/spliter.py,sha256=U3ypm7zKfFuSBFl_2UexT0MWl6vPIcTYOs-vkCxtLwM,13871
 intelliw/docs/Q&A.md,sha256=gA4zWPr0ZRDbFGKRgKc_bYAK0XvYw8y4XjFoSnMJmgs,12226
 intelliw/docs/README.md,sha256=2EG59-UPn-TIYHBVvFeIRZPBcuGlGzTVB7xbbMMwy7I,3144
@@ -40,17 +40,17 @@
 intelliw/functions/feature_process.py,sha256=4xhv3NZMPgu_8GxaEWDtehr0CaDPTaRXf71UmeW2xjE,37584
 intelliw/functions/general.py,sha256=LlqalXzNAYbSl224fhKTo5RH3kdE_T0Ek88Yktj52kQ,619
 intelliw/functions/matrix.py,sha256=8lNKGWC6KaHtw9SvhtF90ptuonjq-EMWWn6PyNv3v6o,1486
 intelliw/functions/opencv.py,sha256=kXruqVOB11DTRdQIB0zZEJi5tx8aubrXrxTaW0Xa_-0,1711
 intelliw/functions/post.py,sha256=cf1c-TJ4bwNwXldAhdr9zOBLBkOT3M4-fMmJQwwbUfM,650
 intelliw/functions/select_columns.py,sha256=U4DNOnCJ3mTOudQx_1TNt2vciPu04zpN7P0RXNGJvk4,779
 intelliw/interface/__init__.py,sha256=Kp7gnULYZPdO7EReW-0DKWdyV7PI-AB9QAB9B8l6Lx8,171
-intelliw/interface/apihandler.py,sha256=OSIodOMsIcoRKIh8P0hR1lByMVU5NdB0gNrSP5iGrsE,12892
+intelliw/interface/apihandler.py,sha256=zfnQ1mR00MSsIE3S8JVtn6i5rz775M8jUkj2mv4gkM4,13133
 intelliw/interface/apijob.py,sha256=SegGN-VANHeu3RMG9IiucaM37L2mElOibePf7d2D6Ls,533
-intelliw/interface/batchjob.py,sha256=a0dlAxnRisCU_H2SQs1SXBznglbPDsEj6jMRkbZLRic,8014
+intelliw/interface/batchjob.py,sha256=B0jvAfpYJJVr1bT8gkepw1NIMxQR2vRcL8XE1FmwjTc,7938
 intelliw/interface/controller.py,sha256=-yIydNuvOe5NpCLRC8Chf7G_usRCDiwUYqzp0kNob0Q,4240
 intelliw/interface/customjob.py,sha256=VdLfeO5K6KldCvLwzfcoOfoWXSKBlGMCThhwKyLZXFM,1255
 intelliw/interface/entrypoint.py,sha256=ZU6g3IiJrvQmOxKg2LydjS6N7qDaXxfVSrmTt6ImRlg,8504
 intelliw/interface/trainjob.py,sha256=rF0f2QxwFmysiz_nOXVTeLG7cQNqbJjFqqYX-wik_fk,1300
 intelliw/utils/.DS_Store,sha256=1lFlJ5EFymdzGAUAaI30vcaaLHt3F1LwpG7xILf9jsM,6148
 intelliw/utils/__init__.py,sha256=aDKkDfNtCrJGzGwd5wvAJfL6u64h9cXe2VmxNYGVsdY,201
 intelliw/utils/cGroup.py,sha256=rdXLH1EIQLs7_v-apxivGoZm6s1bujWadPCjgoUuvb4,4824
@@ -58,22 +58,23 @@
 intelliw/utils/crontab.py,sha256=4Z-M45gFvIea_RoL06MewCPuGRTM17jgR4fu8RD3Vh8,4103
 intelliw/utils/debug_controller.py,sha256=F4S3oY19ZnRoNz_kVhqY1foz3m0R5wa2s2aYKE_566Y,6075
 intelliw/utils/exception.py,sha256=UazMobWm4nS2uXJMoHiG6Kc_oj1mu2yOEVXqv0ihZqo,1983
 intelliw/utils/gen_model_cfg.py,sha256=993YAroB9_Po3kuXpKXdrXwsUY_SsMdnisbWOIhxhVI,2748
 intelliw/utils/global_val.py,sha256=TVjQxrSmZvUPFpKPhl-bCGSm3kT09DLEaw-j6eK-Wko,2126
 intelliw/utils/health_check.py,sha256=rM8nSFlfujqO9m8lbbRpzapL-EoRI9qMVgPdnHxbECQ,44
 intelliw/utils/hijack_function.py,sha256=9af7XrfQM_JwgTCDCZ6BmK_PiC72nzrBlxqaSlQuk5o,2916
-intelliw/utils/iprofile.py,sha256=Cyp5RK2Fg3J-A2hUmNHyxbDUyYKpYLj0mWhT1aF4Zls,1049
-intelliw/utils/iuap_request.py,sha256=j6hfhdkxdLUDyPYNvEiDtwFTYEICSiS9Gq_l4_u-VCk,13632
-intelliw/utils/logger.py,sha256=D2j281KoV5qzcc5nv6WP9cdtdnu1nRMnJIrfSSBJQ0w,4433
-intelliw/utils/message.py,sha256=36Dw3CghaW9DtadHpMc7NHkuGMHecBDvgR5p1oEcbPU,6740
+intelliw/utils/iprofile.py,sha256=cvPvdJjPj4HHvur4wmKGcQxwJ-ZYMDie9sWnYkit9sI,1897
+intelliw/utils/iuap_request.py,sha256=O_q5JbAY6uKI92xyf6u6dK-fsG0DCWmZoj-13BJs9Gg,14423
+intelliw/utils/logger.py,sha256=eKiYPx2McDMguk4eHTUuKLSK6O6jma-ff-kfVssKc_c,4440
+intelliw/utils/memory_profiler.py,sha256=69ivY_aB25faPAPwu12RRHHlSY4SWEdla2_7Yyv9bao,48528
+intelliw/utils/message.py,sha256=8m4j8USfFB3A-pP4FDEsu8cAytqfxlF-EDDWFPPf5ZI,6764
 intelliw/utils/storage_service.py,sha256=4HXOH3OhMDQsUjzf5RCDgMRWFZN0ScoresmA6T9GEbA,6240
-intelliw/utils/util.py,sha256=4E2DqEafmalP6t8a32SHdjQX_sXRr-UGUW0oW8oiDzQ,7354
+intelliw/utils/util.py,sha256=wKo-kF4uqs_eVXs4Gcv8gsWjwMTowOQM_06Y6gnkR2M,7475
 intelliw/utils/yaml_downloader.py,sha256=8DrvTNoa77ch7P8MhgV7cebv-XV1O2Q2s6yLyi1CY9s,346
-intelliw/utils/yms_downloader.py,sha256=w0piHHtpaS5KtykESfNWwqf490p8-JviAw8jmG4c6RA,9180
+intelliw/utils/yms_downloader.py,sha256=nO0Fc2lMQ5g73VPwH67gthJdg43pbZodayqWd-fyHiU,8873
 intelliw/utils/aiocache/__init__.py,sha256=QwZy6d8Ruy69D3CHXoJjpSw0sUr31xcnSVuwPl8h3lk,1163
 intelliw/utils/aiocache/base.py,sha256=kcPMHMCZjNud6Qhne-8IYUIf_6LjwpYKgimhpk8VINI,20436
 intelliw/utils/aiocache/common.py,sha256=n3wQNJoCCScfyP0Ej7Mi1xNd9Q7g7kXIeafXYQhJYqs,829
 intelliw/utils/aiocache/decorators.py,sha256=TY6yyHuVCYTZDl4WXxwwJuU3RKoNmgXZqcuByvFPAUM,19811
 intelliw/utils/aiocache/exceptions.py,sha256=maPdFVMOWUcMoaSZhe_Boxs41b230e9Ak7YXTvkedac,44
 intelliw/utils/aiocache/factory.py,sha256=zgJs6AhedRk1rgIe_wACd74UagmT9Pk98BIv0jVc0_Q,9070
 intelliw/utils/aiocache/lock.py,sha256=O4OHtACNvtEH3chW90CtGH5oZUH_r_ngq2kheBVm0PU,6457
@@ -88,18 +89,18 @@
 intelliw/utils/colorlog/escape_codes.py,sha256=Z9fr6RZL6PDHiqhRMhb9lXclz0Myr3Y89EAa_2jFGjE,2268
 intelliw/utils/colorlog/formatter.py,sha256=zrMtCNw5HEJkiXB0fpBDzDSr6O_hxj3dXmMyZzPzHUE,7791
 intelliw/utils/colorlog/wrappers.py,sha256=9ZTxyYfAfk13-OD1NsaD7i_sLrn7EvooaXp2oZcJ4tc,2212
 intelliw/utils/database/__init__.py,sha256=O1O1dlwx3aI41RN_3R6rhp0-zwHMmsRdf-Fb0N-5_cg,466
 intelliw/utils/database/connection.py,sha256=0_-TatMn_aU8m4O2BScdODH0eymgFpyRgxCHfV6idDk,3253
 intelliw/utils/database/proxy.py,sha256=P5WOq4bwsTUDloOQss901Dij70BbduIQuM-AEeaZNN4,2023
 intelliw/utils/database/schema.py,sha256=a19X5qr3woPC_BQy-HMObgie754xQaDO8UsvTaTd2G0,2605
-intelliw/utils/intelliwapi/__init__.py,sha256=Z2HB3tC07LF9ifmvLKr4O99_fTR7q0q7WI8EBvxYsZw,124
+intelliw/utils/intelliwapi/__init__.py,sha256=EdnfPSMdJ1XSSd5gx1WwowaA1khusKiYwGhyXidyB6w,179
 intelliw/utils/intelliwapi/context.py,sha256=R6zc4Lpg5zd4-5-CAyYpHAnoQnEXyFxW3xX9hW48vG8,892
 intelliw/utils/intelliwapi/gunicorn_server.py,sha256=5LFSLr2aQ8FH9-dt9wnMmTbhsxuGWBztFM14EjXPM1Y,3158
-intelliw/utils/intelliwapi/request.py,sha256=5sPF9pJIkykj4EFgHULyt1qY05f0Jy_0tmcPpKH1Glw,471
+intelliw/utils/intelliwapi/request.py,sha256=Ji-cKv1xqVdky2NmNArNq6tyWl5dp4MC1JSfUel0PL4,602
 intelliw/utils/intelliwapi/response.py,sha256=Zu7mne6rJ7oNKGxZGWz4MWkSiSLGyjbEP79nybs9RPA,547
 intelliw/utils/intelliwapi/workers.py,sha256=GV2ULRp88fPTBNFP42YSLc3MeNPfpiOFr_3OLsBxUF4,3883
 intelliw/utils/logs/iw-algo-fx-framework.log,sha256=eoZeaER2SmRqrYkaRt8x1vL61_hJah_YuQBXyDR_16s,104
 intelliw/utils/logs/iw-algo-fx-user.log,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 intelliw/utils/logs/iw-algo-fx.log,sha256=qaZvL6bL1Q1Kzi30rwVM3pgSsaGSfOYSQOv3fOv-F1U,108
 intelliw/utils/redis/__init__.py,sha256=GohpGBdgt-eXNu4NYa8aAMzMOp-VwzTkSVw_3sO4GWU,2513
 intelliw/utils/redis/common.py,sha256=PGVQqdCWF75gM4MpnPjgcGOlBzi7n-iJcybzvUHPKLE,245
@@ -108,13 +109,13 @@
 intelliw/utils/redis/test.py,sha256=8J5VBKgsHVHdJrcCg5uv0Hu2dStcKZN9-QsJiEs4Z_s,1315
 intelliw/utils/redis/logs/iw-algo-fx-framework.log,sha256=LgIokudCp1huOYd3qTSAYGqUbzX_PsfqlK49tf8pBHg,636
 intelliw/utils/redis/logs/iw-algo-fx-user.log,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 intelliw/utils/redis/logs/iw-algo-fx.log,sha256=cbzUwThdK08CCf0OT4Kkp3unypnzdX4a4VU_W89WBxg,1724
 intelliw/utils/spark_process/__init__.py,sha256=VJ7OMg8K06lStMmcAyZf-BP0MiRnIVPXBhytMYEZDac,200
 intelliw/utils/spark_process/engine.py,sha256=LNdnAxWpNrdfYOL4cqX0MLuyy9lmzJQflTwDH4MappY,26154
 intelliw/utils/spark_process/spark.py,sha256=C9hz566trwIS8iMbsnkVkDMyKwRZzHblBojOSIuoIXY,4420
-intelliw-2.1.0.dist-info/LICENCE,sha256=jOtLnuWt7d5Hsx6XXB2QxzrSe2sWWh3NgMfFRetluQM,35147
-intelliw-2.1.0.dist-info/METADATA,sha256=EzrKT9uwRB5qO-k3wtYLjWERh3QtDXVHuh8njBVkDjA,4940
-intelliw-2.1.0.dist-info/WHEEL,sha256=yQN5g4mg4AybRjkgi-9yy4iQEFibGQmlz78Pik5Or-A,92
-intelliw-2.1.0.dist-info/entry_points.txt,sha256=8Day1wo02R4zN-l1PSIwMp6_qyYRD7eWEUFeQZhMuL4,63
-intelliw-2.1.0.dist-info/top_level.txt,sha256=dmGM8TdTr29-SSGGklu4UuJvUesyssGJcegjlhTaYLE,9
-intelliw-2.1.0.dist-info/RECORD,,
+intelliw-2.1.1.dist-info/LICENCE,sha256=jOtLnuWt7d5Hsx6XXB2QxzrSe2sWWh3NgMfFRetluQM,35147
+intelliw-2.1.1.dist-info/METADATA,sha256=2bmX56pVSwAd6YGvGzgvwvkcNmnxSU_ZkIpVPEdB1v0,4940
+intelliw-2.1.1.dist-info/WHEEL,sha256=yQN5g4mg4AybRjkgi-9yy4iQEFibGQmlz78Pik5Or-A,92
+intelliw-2.1.1.dist-info/entry_points.txt,sha256=8Day1wo02R4zN-l1PSIwMp6_qyYRD7eWEUFeQZhMuL4,63
+intelliw-2.1.1.dist-info/top_level.txt,sha256=dmGM8TdTr29-SSGGklu4UuJvUesyssGJcegjlhTaYLE,9
+intelliw-2.1.1.dist-info/RECORD,,
```

